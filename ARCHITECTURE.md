# Architecture of `breadx`

This file aims to describe the way that `breadx` is structured. This should, hopefully, act as a catalogue of potential starting points for new contributors.

This document assumes some knowledge of the core X11 protocol. Consider reading [this document](https://www.x.org/releases/X11R7.7/doc/xproto/x11protocol.pdf) for more information.

## `generator`

The XCB developers release the protocol of X11 as a set of XML files. A modified version of these files are stored in the `xml` directory. The goal of the `generator` program is to convert this XML description into a Rust implementation of the protocol.

The generator can be viewed in four main phases:

- **Level 1:** Converting XML to data structures roughly analagous to the ones contained in the XML.
- **Level 2:** Converting Level 1 data structures to ones easier to make implementation decisions on. For instance, deciding whether an enum becomes a bitfield or a Rust enum happens in this stage.
- **Level 3:** Converting Level 2 data structures to ones roughly analagous to their Rust counterparts. These structures are converted into `syn` tokens, which are converted to text.
- **Patching:** Running regexes on the data to replace some text with another.

`BTreeMap`s and `BTreeSet`s are used instead of `HashMap`s and `HashSet`s in order to make the generation process deterministic.

## `src/auto`

Code automatically generated by `generator` is put into here. In addition, this is the home of the `AsByteSequence`, `Request`, `Event` and `Error` traits.

The `AsByteSequence` trait should be implemented for any object that can be sent across the X11 connection. It contains functions for conversions to and from a byte stream.

## `src/display`

Most of the user-defined code lies in this module. The module itself defines `Display`, which represents a connection to the X11 server. In practice, the three implementations of `Display` provided are just wrappers around `Connection`s that track the state of the X11 session beyond.

The `Display`s are instantiated by taking a connection, sending data to and from the server to establish a connection, and then using the `Setup` provides by the server to define the initial state. `Display`s can be defined in terms of only two primitive functions: sending data and waiting. Sending data is used to send requests to the server, while waiting waits for events, errors and replies and then sorts them into their respective hash maps, for when the user needs them.

## `src/display/name`

The `NameConnection` is a connection that can be derived from the X11 server name, often stores in the `$DISPLAY` environment variable. This module contains code to parse the display name, and then use that data to create a connection to the server. `NameConnection` is actually an `enum` over `TcpStream` and `UnixStream`, the two types of connections that an X11 name can define.

## `src/display/connection`

The `Connection` trait defines a medium over which communication can take place with the X server. Theoretically, communication can take place over any object that implements `Read` and `Write`. Practically, restrictions that Unix places on FD passing makes it so only `TcpStream` and `UnixStream` can be used.

## `src/display/traits`

This module defines traits that provide convenience methods to use the X protocol.

## `src/auth_info`

This module defines how authorization info from `.Xauthority` is processed and sent to the X server.

## `src/render`

This module defines procedures specific to the `XRender` extension. 
